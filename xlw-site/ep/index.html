<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>xlw: XLW Enhancement Proposal - Excel 2007 Support</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<h1><a class="anchor" name="index">XLW Enhancement Proposal - Excel 2007 Support</a></h1><center><small>last updated <a class="el" href="index.html#ep_revisions">15 October 2007</a></small></center><h2><a class="anchor" name="ep_overview">
Overview</a></h2>
It is proposed to upgrade xlw to support new features of Excel 2007 such as <ul>
<li>larger spreadsheets </li>
<li>longer strings </li>
<li>multithreading </li>
<li>additional function arguments</li>
</ul>
Certain new features of Excel 2007 such as larger spreadsheets and longer strings can be exposed by xlw to its client applications with no change to the xlw interface. When the Addin is loaded, the core xlw library detects the version of Excel under which the XLL is being run, and dynamically supports the new features where possible with no need for changes to legacy source code of xlw client applications. Other new Excel 2007 features such as multithreading necessitate enhancements to the xlw interface and modifications must be made to source code of client applications in order to exploit these new features.<p>
For discussion or feedback on this document please send email to <a href="mailto:xlw-users@lists.sourceforge.net">xlw-users@lists.sourceforge.net</a>.<p>
<a class="el" href="index.html#ep_current">Current Design</a><br>
 <a class="el" href="index.html#ep_constraints">Constraints</a><br>
 <a class="el" href="index.html#ep_new">New Design - XlfOper</a><br>
 <a class="el" href="index.html#ep_xlfoper_4_12">XlfOper4 and XlfOper12</a><br>
 <a class="el" href="index.html#ep_prototype">Prototype</a><br>
 <a class="el" href="index.html#ep_notes">Notes</a><br>
 <a class="el" href="index.html#ep_references">References</a><br>
 <a class="el" href="index.html#ep_revisions">Revision History</a><br>
<h2><a class="anchor" name="ep_current">
Current Design</a></h2>
The crux of the xlw design is that class <code>XlfOper</code>, the wrapper for Excel's <code>XLOPER</code> datatype, is bitwise equivalent to <code>LPXLOPER (XLOPER*)</code>. <code>XlfOper</code> declares a single data member of type <code>LPXLOPER</code> such that <code>sizeof(XlfOper) = sizeof(LPXLOPER)</code>.<p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>XlfOper {
    LPXLOPER lpxloper_;
<span class="keyword">public</span>:
    <span class="keywordtype">double</span> AsDouble();
    ...
};
</pre></div><p>
<code>LPXLOPERs</code> passed from Excel to the Addin are received by Addin functions into arguments of type <code>XlfOper</code>. Consider xlw example function <code>xlCirc</code>, which accepts as input the diameter of a circle, and returns its circumference. This function is registered with Excel such that Excel thinks the datatype of the input parameter is <code>LPXLOPER</code>.<p>
<div class="fragment"><pre class="fragment">LPXLOPER xlCirc(LPXLOPER xlDiam);
</pre></div><p>
In fact the function is declared as accepting an input parameter of type <code>XlfOper</code>.<p>
<div class="fragment"><pre class="fragment">LPXLOPER xlCirc(XlfOper xlDiam);
</pre></div><p>
Excel passes an input argument of type <code>LPXLOPER</code>, which is received by the function into a parameter of type <code>XlfOper</code>. No conversion is performed (i.e. the operation is not type safe). The <code>LPXLOPER</code> value passed by Excel populates the <code>LPXLOPER</code> data member of the <code>XlfOper</code> argument. <code>XlfOper's</code> member functions then serve as functionality bound to that reference, and the implementation of xlCirc accesses the <code>LPXLOPER</code> via its <code>XlfOper</code> wrapper.<p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">double</span> diam = xlDiam.AsDouble();
</pre></div><h2><a class="anchor" name="ep_constraints">
Constraints</a></h2>
xlw is enhanced to support Excel 2007 (Excel version 12), in which <code>LPXLOPER</code> is deprecated in favor of <code>LPXLOPER12 (XLOPER12*)</code> which has a modified structure in support of larger spreadsheets, longer strings, and other Excel 12 features.<p>
To ensure a smooth transition for xlw client applications, xlw is enhanced within constraints: <ul>
<li>No legacy code of xlw client applications is broken i.e. changes to the xlw interface are backward compatible </li>
<li>During runtime initialization of the client XLL, the core xlw library detects the version of Excel and <code>XlfOper</code> then proxies <code>LPXLOPER</code> or <code>LPXLOPER12</code> as appropriate</li>
</ul>
Without modification, client xlw applications when loaded by Excel 12 silently pick up enhanced features such as larger range references, while preserving existing behavior when run under older versions of Excel. It is of course necessary to recompile the client application against the new version of xlw. Additional features of Excel 12 such as multithreading are exposed by xlw through additional properties in the xlw interface and xlw client apps require enhancement to invoke such new features.<h2><a class="anchor" name="ep_new">
New Design - XlfOper</a></h2>
Class XlfOper is enhanced to allow it to occupy the memory footprint of either <code>LPXLOPER</code> or <code>LPXLOPER12</code>.<p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>XlfOper {
    <span class="keyword">union </span>{ 
        LPXLOPER lpxloper4_;
        LPXLOPER12 lpxloper12_;
    };
<span class="keyword">public</span>:
    <span class="keywordtype">double</span> AsDouble();
    ...
};
</pre></div><p>
Now the class requires run time logic to determine which pointer to dereference. Ideally the switch is implemented via polymorphism, e.g. some abstract notion of an <code>LPXLOPER</code>, concretely instantiated as either <code>LPXLOPER</code> (4) or <code>LPXLOPER12</code> depending on which version of Excel is detected. Various obstacles prevent this logic from being added to class <code>XlfOper</code>, the most immediate is that the class cannot contain virtual member functions as the corresponding vtable would result in <code>XlfOper</code> no longer being bitwise equivalent to <code>LPXLOPER</code>.<p>
The logic around the <code>LPXLOPER/LPXLOPER12</code> reference is passed off to friend class <code>XlfOperImpl</code>. <code>XlfOper</code> can't hold a reference to <code>XlfOperImpl</code> so instead the latter is implemented as a polymorphic Singleton, an abstract base class which is instantiated at runtime by one of two concrete derived classes, <code>XlfOperImpl4</code> or <code>XlfOperImpl12</code>, depending on which version of Excel is detected.<p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>XlfOperImpl {
    <span class="keyword">static</span> XlfOperImpl *instance_;
<span class="keyword">public</span>: 
    <span class="keyword">static</span> XlfOperImpl &amp;instance() { <span class="keywordflow">return</span> *instance_; }
    XlfOperImpl() { instance_ = <span class="keyword">this</span>; }
    <span class="keyword">virtual</span> <span class="keywordtype">double</span> AsDouble(<span class="keyword">const</span> XlfOper &amp;xlfOper) = 0;
};  

<span class="keyword">class </span>XlfOperImpl4 : <span class="keyword">public</span> XlfOperImpl {
    <span class="keyword">virtual</span> <span class="keywordtype">double</span> AsDouble(<span class="keyword">const</span> XlfOper &amp;xlfOper) {
        <span class="keywordflow">return</span> xlfOper.lpxloper4_-&gt;val.num;
    }   
};

<span class="keyword">class </span>XlfOperImpl12 : <span class="keyword">public</span> XlfOperImpl {
    <span class="keyword">virtual</span> <span class="keywordtype">double</span> AsDouble(<span class="keyword">const</span> XlfOper &amp;xlfOper) {
        <span class="keywordflow">return</span> xlfOper.lpxloper12_-&gt;val.num;
    }
};
</pre></div><p>
Calls to <code>XlfOper</code> are forwarded to <code>XlfOperImpl</code> for execution by the appropriate derived class.<p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">double</span> XlfOper::AsDouble() {
    <span class="keywordflow">return</span> XlfOperImpl::instance().AsDouble(*<span class="keyword">this</span>);
}
</pre></div><h2><a class="anchor" name="ep_xlfoper_4_12">
XlfOper4 and XlfOper12</a></h2>
The proposed new implementation of <code>XlfOper</code> allows for a seamless upgrade, at the cost of some runtime performance. The cost is not warranted for applications that know they always require <code>LPXLOPER</code> or <code>LPXLOPER12</code>, and so new classes <code>XlfOper4</code> and <code>XlfOper12</code> are provided to map directly to those types.<p>
The table below summarizes the advantages and disadvantages of the supported interfaces.<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td><b>Class</b></td><td><b><center>+</center></b></td><td><b><center>-</center></b> </td></tr>
<tr>
<td><b>XlfOper</b> </td><td><ul>
<li>Automatically encapsulates either LPXLOPER or LPXLOPER12 </li>
<li>Backward compatible with old <code>XlfOper</code> class  </li>
</ul>
</td><td><ul>
<li>Incurs a run time overhead. Each member function forwards its call to a virtual function in the <code>XlfOperImpl</code> singleton.   </li>
</ul>
</td></tr>
<tr>
<td><b>XlfOper4</b> </td><td><ul>
<li>Backward compatible with old <code>XlfOper</code> class </li>
<li>No performance overhead compared to old <code>XlfOper</code> class  </li>
</ul>
</td><td><ul>
<li>Encapsulates LPXLOPER only </li>
<li>Supported by Excel 12 but invokes none of Excel 12's new features   </li>
</ul>
</td></tr>
<tr>
<td><b>XlfOper12</b> </td><td><ul>
<li>No performance overhead compared to old <code>XlfOper</code> class  </li>
</ul>
</td><td><ul>
<li>Encapsulates LPXLOPER12 only </li>
<li>Not supported by Excel 4   </li>
</ul>
</td></tr>
</table>
<p>
Legacy code references to <code>XlfOper</code> map by default to the new <code>XlfOper</code> class. The new build of xlw provides preprocessor symbols allowing legacy code to <code>#define</code> <code>XlfOper</code> to <code>XlfOper4</code> or <code>XlfOper12</code> if desired.<h2><a class="anchor" name="ep_prototype">
Prototype</a></h2>
Below are links to directories in the xlw subversion repository containing a Visual C++ 2005 console (DOS) project which prototypes the design proposed in this document.<p>
To browse online:<p>
<a href="http://xlw.svn.sourceforge.net/viewvc/xlw/branches/prototype/">http://xlw.svn.sourceforge.net/viewvc/xlw/branches/prototype/</a><p>
For checkout by an svn client such as TortoiseSVN:<p>
<a href="https://xlw.svn.sourceforge.net/svnroot/xlw/branches/prototype/">https://xlw.svn.sourceforge.net/svnroot/xlw/branches/prototype/</a><h2><a class="anchor" name="ep_notes">
Notes</a></h2>
<ul>
<li>The existing <code>XlfOper</code> class declares data member lpxloper_ public, even though a public accessor is also supplied. lpxloper4_/lpxloper12_ are declared private in the new <code>XlfOper</code> class.</li>
</ul>
<h2><a class="anchor" name="ep_references">
References</a></h2>
<a href="http://msdn2.microsoft.com/en-US/library/aa730920.aspx">Developing Add-ins (XLLs) in Excel 2007</a><br>
 <a href="http://xlw.sourceforge.net/html/index.html">XLW Documentation</a><h2><a class="anchor" name="ep_revisions">
Revision History</a></h2>
The table below summarizes the revision history for this document.<p>
<table border="1" cellspacing="3" cellpadding="3">
<tr>
<td><b>Date</b></td><td><b>Revision</b> </td></tr>
<tr>
<td>15-October-2007 </td><td><ul>
<li>Link to prototype code in svn repository </li>
<li>Update prototype to emphasize that when Excel passes values of type <code>LPXLOPER</code> to an xlw Addin function having parameters of type <code>XlfOper</code> no <code>XlfOper</code> ctor is invoked </li>
</ul>
</td></tr>
<tr>
<td>15-October-2007</td><td>Initial draft </td></tr>
</table>

<hr size="1">
<div><center><small>Copyright &#169; 2007 Eric Ehlers / nazcatech sprl belgium&nbsp;&nbsp;&nbsp;l&nbsp;&nbsp;&nbsp;Published under the <a href="http://xlw.sourceforge.net/license.html">xlw license</a></small></center></div>
<div><center><small>Hosted by&nbsp;</small><a href="http://sourceforge.net/"><img src="sflogo.php" alt="sourceforge" align="middle" border="0"></a></center></div>

